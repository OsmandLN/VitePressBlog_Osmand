import{_ as l,c as n,a as i,a2 as a,m as s,o as t}from"./chunks/framework.CWo5xHl-.js";const B=JSON.parse('{"title":"[JS]關於非同步處理機制","description":"","frontmatter":{"title":"[JS]關於非同步處理機制"},"headers":[],"relativePath":"docs/notes/articles/JS-async_event_loop.md","filePath":"docs/notes/articles/JS-async_event_loop.md"}'),e={name:"docs/notes/articles/JS-async_event_loop.md"},p=a(`<p><img src="https://static.coderbridge.com/img/OsmandLN/7b95351b49dd4e129e10eaaba67671e7.png" alt=""> (機制流程圖要借別人的來用好像不是那麼方便，反正也不難畫，乾脆自己畫一張好了 XD)</p><ol><li><p>瀏覽器主執行環境開始執行堆疊(Stack)內的程式</p></li><li><p>全域環境下的程式碼直接被執行</p></li><li><p>執行時遇到 Web API，常見的如: DOM、AJAX、setTimeout。DOM、AJAX 不會立即被執行，其 callback function 被放進事件佇列(Callback Queue)裡做等待，而 setTimeout、setInterval 等需要計時的 Web API，其計時器開始計時，計時完畢後，callback function 放入事件佇列等待。</p></li><li><p>與此同時，Event loop 會持續檢查堆疊中是否為空，如果為空，則把事件佇列中的 callback function 拉進堆疊中作執行。</p></li><li><p>重複步驟 4，直到所有程式被執行完畢。</p></li></ol><h4 id="然後-遇到-promise-後才發現-原來程式還有分大小" tabindex="-1">然後...遇到 Promise 後才發現...原來程式還有分大小?! <a class="header-anchor" href="#然後-遇到-promise-後才發現-原來程式還有分大小" aria-label="Permalink to &quot;然後...遇到 Promise 後才發現...原來程式還有分大小?!&quot;">​</a></h4><p>Promise 與上述提及的 Web API 如 setTimeout 在處理非同步行為的機制上有所不同，要解釋不同之處，就要提及兩個關鍵名詞: Macrotask 及 Microtask。</p><p>Macrotask 以中文直譯就是宏觀的任務，簡單地說，就是在 Event Queue 裡面等著被以非同步方式執行的程式 ; 而 Microtask 通常由 Promise 產生。</p><p>相較於 Web API 的 Macrotask 由 Macrotask Queue 管理，Microtask 則會由 Microtask Queue 進行管理。</p><p>當一項 Macrotask 被執行完成後，Event loop 會去檢查 Microtask Queue 中是否有 Microtask 要執行，如果有，瀏覽器會優先執行這些 Microtask，直到 Microtask Queue 清空為止。</p><p>也就是說，Microtask 的執行是穿插在 Macrotask 的執行之間。</p><br><p>以下來看看關於非同步的觀念題，可以先想一下之後再看答案:</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> first</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      setTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    p.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">arg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(arg)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">arg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(arg)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><br>`,12),h=s("br",null,null,-1),k=s("br",null,null,-1),r=s("br",null,null,-1),E=s("br",null,null,-1),o=s("br",null,null,-1),c=s("br",null,null,-1),d=s("br",null,null,-1),g=s("br",null,null,-1),y=a('<br><br><p><strong>答案是: 3 → 7 → 4 → 1 → 2 → 5 </strong></p><p>分析如下: (原則: 先同步再非同步，非同步的執行: macrotask → microtask → macrotask)</p><ol><li>程式由上而下執行，先遇到first函式被呼叫，進到內部第一層promise，印出3。</li><li>繼續往下看，p在宣告後被呼叫，callback function內由上而下，印出7。</li><li>執行全域下的同步任務，印出4。</li><li>再來由上而下處理非同步任務部分，p裡面的resolve(1)內的1會被p.then的.then callback接住，並印出1。</li><li>first函式中resolve(2)內的2，會被first().then的.then callback接住，並印出2。</li><li>執行setTimeout這個macrotask內的程式碼，印出5。</li><li>setTimeout內的resolve(6)，由於沒有.then callback接住，也就無法在接住後進一步印出，故不會在console中看到。</li></ol><p>JavaScript真的是很神奇的語言，明明只有單執行緒，卻能巧妙運用非同步機制處理這麼多事。</p><p>關於非同步機制的研究到這邊暫告一段落囉，咱們下次見!</p><hr><p>參考資料:</p><ol><li><p><a href="https://www.casper.tw/javascript/2017/12/29/javascript-proimse/" target="_blank" rel="noreferrer">鐵人賽：使用 Promise 處理非同步| 卡斯伯 Blog - 前端，沒有極限</a></p></li><li><p><a href="https://medium.com/itsems-frontend/javascript-event-loop-event-queue-call-stack-74a02fed5625" target="_blank" rel="noreferrer">https://medium.com/itsems-frontend/javascript-event-loop-event-queue-call-stack-74a02fed5625</a></p></li><li><p><a href="https://iter01.com/1681.html" target="_blank" rel="noreferrer">https://iter01.com/1681.html</a></p></li><li><p>JavaScript 概念三明治 (蔡木景 著)</p></li><li><p><a href="https://123davidbill.medium.com/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%A9%A6%E5%BF%85%E8%80%83%E9%A1%8C-promise-a5f7582be3e0" target="_blank" rel="noreferrer">https://123davidbill.medium.com/前端面試必考題-promise-a5f7582be3e0</a></p></li><li><p><a href="https://pjchender.dev/javascript/js-promise/" target="_blank" rel="noreferrer">https://pjchender.dev/javascript/js-promise/</a></p></li></ol>',10);function F(_,m,u,b,C,v){return t(),n("div",null,[p,i(" ----我----"),h,k,i(" ----是----"),r,E,i(" ----防----"),o,c,i(" ----雷----"),d,g,i(" ----區----"),y])}const f=l(e,[["render",F]]);export{B as __pageData,f as default};
